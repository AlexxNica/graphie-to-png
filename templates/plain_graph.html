<!doctype html>
<html>
<head>
{% block head %}
<title>graphie to png</title>
{% endblock head %}
<link rel="stylesheet" href="static/css/graphie-to-png.css" />
<link rel="stylesheet" href="static/js/khan-exercises/local-only/katex/katex.css" />
<link rel="stylesheet" href="static/css/font-awesome-font.css" />
</head>
<body>
{% block content %}
{% endblock content %}

{% if js %}
<div class="graphie">{{js}}</div>
{% endif %}

{% block scripts %}
<script>
    var KhanUtil = {
        debugLog: function() {}
    };
    var Khan = {
        Util: KhanUtil,
        query: {debug: ""},
        error: function() {}
    };
    var Perseus = {};
</script>

<script src="static/js/khan-exercises/local-only/jquery.js"></script>
<script src="static/js/khan-exercises/local-only/jed.js"></script>
<script src="static/js/khan-exercises/local-only/i18n.js"></script>
<script src="static/js/khan-exercises/local-only/localeplanet/icu.en.js"></script>
<script src="static/js/khan-exercises/local-only/underscore.js"></script>
<script src="static/js/khan-exercises/third_party/MathJax/2.1/MathJax.js?config=KAthJax-8f02f65cba7722b3e529bd9dfa6ac25d"></script>

<script src="static/js/khan-exercises/local-only/katex/katex.js"></script>
<script src="static/js/khan-exercises/exercises-stub.js"></script>
<script>Exercises.useKatex = false;</script>
<script src="static/js/khan-exercises/local-only/require.js"></script>

<script src="static/js/image-library.js"></script>
<script src="static/js/perseus/util.js"></script>

<script>
window.webkit2png = window.webkit2png || {start: $.noop, stop: $.noop};
window.keUtilsLoaded = $.Deferred();

webkit2png.stop();

require([
    "static/js/khan-exercises/utils/tmpl.js",
    "static/js/khan-exercises/utils/tex.js",
    "static/js/khan-exercises/utils/knumber.js",
    "static/js/khan-exercises/utils/kvector.js",
    "static/js/khan-exercises/utils/kmatrix.js",
    "static/js/khan-exercises/utils/kpoint.js",
    "static/js/khan-exercises/utils/kline.js",
    "static/js/khan-exercises/utils/math.js",
    "static/js/khan-exercises/utils/math-format.js",
    "static/js/khan-exercises/utils/graphie.js",
    "static/js/khan-exercises/utils/angles.js",
    "static/js/khan-exercises/utils/expressions.js",
    "static/js/khan-exercises/utils/graphie-geometry.js",
    "static/js/khan-exercises/utils/graphie-helpers.js",
    "static/js/khan-exercises/utils/graphie-helpers-arithmetic.js",
    "static/js/khan-exercises/utils/word-problems.js",
    "static/js/khan-exercises/utils/interactive.js",
    "static/js/khan-exercises/utils/graphie-drawing.js",
    "static/js/khan-exercises/utils/graphie-3d.js",
    "static/js/khan-exercises/utils/time.js"
], function() {

// For backward compatibility with figures created before things were better namespaced
KhanUtil.lineMidpoint = KhanUtil.kline.midpoint;

// Stupid image hack to wait for images to load :(
var waitForImages = function(callback) {
    var $images = $('.graphie > svg > image');
    var imagesLeft = $images.length;
    var checkForLoaded = function() {
        if (imagesLeft === 0) {
            callback();
        }
    };
    var imageWasLoaded = function() {
        imagesLeft--;
        checkForLoaded();
    };

    $.each($images, function() {
        var href = $(this).attr("href");
        if (!href.match(/amazonaws\.com/)) {
            $(".graphie").empty().append($("<div class='error'>").text(
                "only images uploaded with\nperseus may be hotlinked"
            ));
            imageWasLoaded();
            return;
        }
        var tempImage = new Image();
        tempImage.onload = imageWasLoaded;
        tempImage.onerror = imageWasLoaded;
        tempImage.src = href;
    });

    checkForLoaded();
};

try {
    $(".graphie").graphie();

    MathJax.Hub.Queue(function() {
        waitForImages(function() {
            webkit2png.start();
        });
    });
} catch(e) {
    $(".graphie").empty().append($("<div class='error'>").text(e.message));
    webkit2png.start();
}

keUtilsLoaded.resolve();


});
</script>
{% endblock scripts %}

</body>
</html>
